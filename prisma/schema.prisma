// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== AUTH ====================

enum Role {
  USER
  ADMIN
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  role          Role      @default(USER)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions      Session[]
  accounts      Account[]
  patients      Patient[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// ==================== IMUNISASI ====================

enum Gender {
  LAKI_LAKI
  PEREMPUAN
}

model Patient {
  id            String   @id @default(cuid())
  
  // Data Anak
  name          String
  birthDate     DateTime
  gender        Gender
  placeOfBirth  String?
  nik           String? 
  
  // Data Orang Tua/Wali
  motherName    String?
  fatherName    String?
  nikmother     String?  
  nikfather     String? 
  phoneNumber   String?
  
  // Data Alamat
  districtId    String?
  districtName  String?
  villageId     String?
  villageName   String?
  address       String?  @db.Text
  
  // System
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  posyanduId     String?
  posyandu       Posyandu? @relation("HomePosyandu", fields: [posyanduId], references: [id])

  isActive Boolean @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // ‚≠ê Relations
  immunizationRecords ImmunizationRecord[]
  vaccineHistories    VaccineHistory[]      // ‚≠ê NEW: Direct relation ke vaccine history

  @@index([name])
  @@index([nik])
  @@index([nikmother])
  @@index([nikfather])
  @@index([motherName, fatherName])
  @@index([phoneNumber])
  @@index([districtId, villageId])
}

model Vaccine {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  @db.Text
  
  // ‚≠ê NEW: Vaccine details
  ageMonthMin Int      @default(0)         // Usia minimal (bulan)
  ageMonthMax Int?                         // Usia maksimal (bulan), null = no limit
  totalDoses  Int      @default(1)         // Jumlah dosis (1-5)
  intervalDays Int?                        // Interval antar dosis (hari)
  order       Int      @default(0)         // Urutan tampil di form
  isActive    Boolean  @default(true)      // Aktif/nonaktif
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // ‚≠ê Relations
  vaccineHistories VaccineHistory[]        // ‚≠ê NEW: Track history per vaksin
  
  @@index([order])
  @@index([isActive])
}

model Posyandu {
  id           String     @id @default(cuid())
  name         String
  address      String     @db.Text
  
  // Data Alamat
  districtId   String?
  districtName String?
  villageId    String?
  villageName  String?
  
  HomePatients     Patient[] @relation("HomePosyandu")
  schedules    Schedule[]

  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

enum ScheduleStatus {
  UPCOMING   // Belum dimulai
  ONGOING    // Sedang berlangsung
  COMPLETED  // Selesai (auto-lock vaccine histories)
  CANCELLED  // Dibatalkan
}

model Schedule {
  id           String         @id @default(cuid())
  date         DateTime
  status       ScheduleStatus @default(UPCOMING)
  
  posyanduId   String
  posyandu     Posyandu       @relation(fields: [posyanduId], references: [id], onDelete: Cascade)
  
  notes        String?        @db.Text
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  // ‚≠ê Relations
  immunizationRecords ImmunizationRecord[]
  vaccineHistories    VaccineHistory[]     // ‚≠ê NEW: Track vaccines per schedule
  
  @@index([date])
  @@index([status])
}

enum AttendanceStatus {
  WAITING   // Menunggu antrian
  SERVED    // Sudah dilayani
  CANCELLED // Dibatalkan (sakit, dll)
}

model ImmunizationRecord {
  id          String           @id @default(cuid())
  
  patientId   String
  patient     Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  scheduleId  String
  schedule    Schedule         @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  status      AttendanceStatus @default(WAITING)
  notes       String?          @db.Text  // Catatan (untuk CANCELLED: alasan batal)
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // üëá CHANGE 2: Relation ke VaccineHistory
  // Supaya kalau check-in (Record) dihapus, data suntikan (History) ikut kehapus.
  vaccineHistories VaccineHistory[]
  
  // ‚≠ê REMOVED: vaccines Vaccine[] (diganti VaccineHistory)
  
  @@unique([patientId, scheduleId])
  @@index([patientId, scheduleId])
  @@index([status])
}

// ‚≠ê NEW: Junction Table dengan Locking Mechanism
model VaccineHistory {
  id          String   @id @default(cuid())
  administeredBy String?
  
  // Relations
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  vaccineId   String
  vaccine     Vaccine  @relation(fields: [vaccineId], references: [id], onDelete: Restrict)
  
  scheduleId  String
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Ini menghubungkan "Tindakan" ke "Kunjungan" yang spesifik.
  immunizationRecordId String
  immunizationRecord   ImmunizationRecord @relation(fields: [immunizationRecordId], references: [id], onDelete: Cascade)
  
  // Data
  givenAt     DateTime @default(now())  // Kapan vaksin diberikan
  doseNumber  Int      @default(1)      // Dosis ke-berapa (1, 2, 3, dst)
  notes       String?  @db.Text         // Catatan per vaksin
  
  // ‚≠ê Locking mechanism
  isLocked    Boolean  @default(false)  // Auto true saat schedule COMPLETED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([patientId, vaccineId, doseNumber])  // Prevent duplicate
  @@index([patientId])
  @@index([scheduleId])
  @@index([vaccineId])
  @@index([isLocked])
}


